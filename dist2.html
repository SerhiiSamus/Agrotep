<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Розрахунок відстані між містами</title>
    <style>
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
      }
      th {
        background-color: #f2f2f2;
        text-align: left;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  </head>
  <body>
    <h1>Розрахунок відстані між містами</h1>
    <input type="file" id="fileInput" accept=".xlsx, .xls" />
    <table id="resultTable">
      <thead>
        <tr>
          <th>Маршрут</th>
          <th>Відстань (км)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Результати будуть вставлені тут -->
      </tbody>
    </table>

    <script>
      document
        .getElementById('fileInput')
        .addEventListener('change', handleFile, false);

      async function handleFile(e) {
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = async function (event) {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const cityPairs = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          // Видаляємо заголовок таблиці
          cityPairs.shift();

          await calculateDistances(cityPairs);
        };

        reader.readAsArrayBuffer(file);
      }

      async function calculateDistances(cityPairs) {
        const resultTableBody = document
          .getElementById('resultTable')
          .getElementsByTagName('tbody')[0];
        resultTableBody.innerHTML = '';

        for (const pair of cityPairs) {
          const originCell = pair[0] || '';
          const destinationCell = pair[1] || '';
          const origins = originCell
            .split(',')
            .map((city) => city.trim())
            .filter(Boolean);
          const destinations = destinationCell
            .split(',')
            .map((city) => city.trim())
            .filter(Boolean);

          // Об'єднуємо міста відправлення та прибуття в один маршрут
          const route = [...origins, ...destinations];
          if (route.length < 2) {
            const newRow = resultTableBody.insertRow();
            newRow.insertCell(0).innerText =
              route.join(' -> ') || 'Порожній маршрут';
            newRow.insertCell(1).innerText = 'Неможливо розрахувати відстань';
            continue;
          }

          const coordinates = [];
          for (let i = 0; i < route.length; i++) {
            const coords = await getCoordinates(route[i]);
            if (coords) {
              coordinates.push(coords);
            } else {
              break;
            }
          }

          if (coordinates.length < route.length) {
            const newRow = resultTableBody.insertRow();
            newRow.insertCell(0).innerText = route.join(' -> ');
            newRow.insertCell(1).innerText = 'Не вдалося розрахувати відстань';
            continue;
          }

          const distance = await getDistance(coordinates);

          const newRow = resultTableBody.insertRow();
          newRow.insertCell(0).innerText = route.join(' -> ');
          newRow.insertCell(1).innerText =
            distance !== null ? distance : 'Не вдалося розрахувати відстань';
        }
      }

      async function getCoordinates(city) {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${city}`
        );
        const data = await response.json();
        console.log(data);
        if (data.length > 0) {
          return [data[0].lat, data[0].lon];
        } else {
          return null;
        }
      }

      async function getDistance(coordinates) {
        const coordString = coordinates
          .map((coord) => `${coord[1]},${coord[0]}`)
          .join(';');
        const response = await fetch(
          `http://router.project-osrm.org/route/v1/driving/${coordString}?overview=false`
        );
        const data = await response.json();
        console.log(data);
        if (data.routes.length > 0) {
          const distanceInMeters = data.routes[0].distance;
          return (distanceInMeters / 1000).toFixed(2); // Перетворення метри в кілометри і округлення
        } else {
          return null;
        }
      }
    </script>
  </body>
</html>
